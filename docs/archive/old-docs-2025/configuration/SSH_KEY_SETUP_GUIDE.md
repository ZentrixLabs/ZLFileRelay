# SSH Key Setup Guide for ZL File Relay

## Overview
This guide clarifies SSH key configuration for the ZL File Relay service, specifically addressing how to set up SSH keys when the Windows Service runs under a service account.

> **New Feature**: The Config Tool now supports browsing and testing SSH keys in the service account's security context. When prompted for service account credentials, the tool can access keys in the service account's profile folder (e.g., `C:\Users\svc_filetransfer\.ssh\`).

## Config Tool Service Account Context

### Why Service Account Context is Needed

When the Config Tool runs as Administrator, it cannot access files that only the service account has permission to read. This is especially true for SSH keys stored in the service account's profile folder or files with restricted NTFS permissions.

### How It Works

1. **Browse for SSH Keys**: When browsing for SSH keys, the tool may prompt for service account credentials to access folders like `C:\Users\svc_filetransfer\.ssh\`. The file browser runs in the service account's security context, allowing access to protected files.

2. **Test SSH Connection**: When testing the SSH connection, the tool uses impersonation to read the SSH private key with the same permissions the service account would have. This ensures the test accurately reflects whether the service can access the key.

### When You'll Be Prompted

You will be prompted for service account credentials when:
- The SSH key is in the service account's profile folder
- The SSH key has NTFS permissions that only the service account can read
- You're testing the SSH connection and the key requires service account access

### Credential Caching

- Credentials are cached in memory for the current session
- You can check "Remember for this session" to avoid repeated prompts
- Credentials are never saved to disk and are cleared when the Config Tool closes

## Understanding SSH Key Authentication

### Key Pair Concept
SSH uses **asymmetric cryptography** with a key pair:

- **Private Key** (e.g., `id_ed25519`, `server.key`, `private.pem`, `zlrelay_key`)
  - Stays on the **LOCAL server** (where ZL File Relay service runs)
  - Used by the service to authenticate to remote servers
  - **MUST be kept secret and secure**
  - Common extensions: **NO extension**, `.key`, or `.pem`
  
- **Public Key** (e.g., `id_ed25519.pub`, `server.pub`, `public.pem`)
  - Deployed to the **REMOTE server(s)**
  - Added to `~/.ssh/authorized_keys` file on the remote server
  - Can be shared publicly (it's called "public" for a reason!)
  - Common extensions: `.pub` or `.pem`

> **Note on .key vs .pem naming:**  
> Many systems use `.key` for the private key and `.pem` for the public key/certificate, even though both files are in PEM format. This is just a naming convention - the actual format is what matters, not the extension.

### File Formats
ZL File Relay supports these SSH key formats:

1. **OpenSSH Format** (Recommended)
   - Generated by `ssh-keygen` on Windows/Linux
   - Example private key: `id_ed25519`, `id_rsa`
   - Example public key: `id_ed25519.pub`, `id_rsa.pub`
   
2. **PEM Format** (Legacy/Web Server Convention)
   - Common with older tools and web servers
   - Can use various extensions:
     - Private key: `server.key`, `private.pem`, `domain.key`
     - Public key/cert: `server.pem`, `public.pem`, `domain.pem`
   - Still widely supported

> **Common Naming Conventions:**
> 
> **OpenSSH Style** (Linux/Unix):
> - Private: `id_ed25519` (no extension)
> - Public: `id_ed25519.pub`
> 
> **Web Server Style** (Apache/Nginx):
> - Private: `server.key` or `domain.key`
> - Certificate: `server.pem` or `domain.pem` or `server.crt`
> 
> **Generic Style**:
> - Private: `private_key.pem` or `mykey.key`
> - Public: `public_key.pem` or `mykey.pub`
>
> All these work with ZL File Relay! Just browse to the **private** key file.

### Key Types
The tool generates **ED25519** keys by default:
- âœ… **ED25519** (Recommended)
  - Modern, fast, and secure
  - Smaller key size (256-bit)
  - Resistant to timing attacks
  
- âš ï¸ **RSA** (Legacy)
  - Widely supported but older
  - Requires 2048-bit or 4096-bit keys
  - Slower than ED25519

## Complete Setup Process

### Part 1: Service Account Preparation (One-Time)

#### Why This Matters
The Windows Service runs as a **service account** (not as your user account). This service account needs:
1. A user profile on the server
2. Read access to the SSH private key file

#### Steps

**1. Create the Service Account Profile**

The service account must login at least once to create its user profile:

```powershell
# Run this in an elevated PowerShell or Command Prompt
runas /user:DOMAIN\svc_filetransfer cmd
```

Replace `DOMAIN\svc_filetransfer` with your actual service account.

This creates the profile directory:
- `C:\Users\svc_filetransfer\`

**2. Verify Profile Creation**

Check that the profile exists:
```powershell
Test-Path "C:\Users\svc_filetransfer"
# Should return: True
```

**3. Grant SSH Key Access (After Key Generation)**

After generating SSH keys, grant the service account read access:

```powershell
# Grant read access to the private key file
icacls "C:\ProgramData\ZLFileRelay\ssh\zlrelay_key" /grant "DOMAIN\svc_filetransfer:R"
```

Or use the **Service** tab in the Config Tool to set permissions automatically.

### Part 2: Generate SSH Keys

#### Using the Config Tool (Recommended)

1. Open **ZL File Relay Configuration Tool**
2. Go to **File Transfer** tab
3. Select **SSH/SCP** as transfer method
4. Click **"Generate Key Pair"** button

The tool will:
- Generate an ED25519 key pair
- Save to `C:\ProgramData\ZLFileRelay\ssh\zlrelay_key` (private)
- Save to `C:\ProgramData\ZLFileRelay\ssh\zlrelay_key.pub` (public)
- Automatically fill in the private key path

#### Using ssh-keygen Manually

If you prefer manual generation:

```powershell
# Create directory
New-Item -ItemType Directory -Force -Path "C:\ProgramData\ZLFileRelay\ssh"

# Generate ED25519 key
ssh-keygen -t ed25519 -f "C:\ProgramData\ZLFileRelay\ssh\zlrelay_key" -N "" -C "ZLFileRelay"
```

Then in the Config Tool:
1. Click **"Browse..."** next to "Private Key File"
2. Navigate to `C:\ProgramData\ZLFileRelay\ssh\`
3. Select `zlrelay_key` (the file **WITHOUT** `.pub` extension)

### Part 3: Deploy Public Key to Remote Server

#### For Linux Remote Servers

**Method 1: Manual Copy (Most Common)**

1. In Config Tool, click **"View Public Key"**
2. Click **"Copy to Clipboard"**
3. SSH to your remote server as the destination user
4. Append the public key to authorized_keys:

```bash
# On the remote Linux server
mkdir -p ~/.ssh
chmod 700 ~/.ssh
echo "ssh-ed25519 AAAAC3Nza... ZLFileRelay" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

**Method 2: Using ssh-copy-id (If Available)**

```bash
# From Windows (if ssh-copy-id is available)
ssh-copy-id -i "C:\ProgramData\ZLFileRelay\ssh\zlrelay_key.pub" user@remote-server
```

#### For Windows Remote Servers (OpenSSH)

1. Copy the public key content (from Config Tool)
2. On the remote Windows server:

```powershell
# Create .ssh directory if it doesn't exist
New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.ssh"

# Add public key to authorized_keys
Add-Content -Path "$env:USERPROFILE\.ssh\authorized_keys" -Value "ssh-ed25519 AAAAC3Nza... ZLFileRelay"

# Set proper permissions
icacls "$env:USERPROFILE\.ssh\authorized_keys" /inheritance:r /grant:r "$env:USERNAME:F"
```

### Part 4: Configure Connection Details

In the **File Transfer** tab:

1. **Host**: IP address or hostname of remote server
   - Example: `192.168.1.100` or `scada-server.example.com`

2. **Port**: SSH port (usually 22)
   - Default: `22`
   - Custom: `2222` if non-standard

3. **Username**: SSH username on remote server
   - Example: `svc_filetransfer` or `fileuser`
   - Must match the user whose `authorized_keys` you modified

4. **Destination Path**: Where files will be transferred
   - Linux: `/data/incoming` or `/opt/transfer`
   - Windows: `C:/Transfer` or `/c/Transfer`

5. **Remote Server Type**: 
   - Select **"Linux"** for Linux/Unix servers
   - Select **"Windows"** for Windows OpenSSH servers

6. **Private Key File**: Path to private key (auto-filled after generation)
   - Example: `C:\ProgramData\ZLFileRelay\ssh\zlrelay_key`
   - Browse to the file **WITHOUT** `.pub` extension

### Part 5: Test the Connection

1. Click **"Test SSH Connection"** button
2. Review the results in the test output area
3. Successful test shows:
   - âœ… Connection established
   - âœ… Authentication successful
   - âœ… Destination path accessible

**Common Test Failures:**

| Error | Cause | Solution |
|-------|-------|----------|
| Connection timeout | Wrong host/port, firewall | Check network connectivity, firewall rules |
| Authentication failed | Wrong username or key not deployed | Verify username, check authorized_keys on remote |
| Permission denied | Public key not in authorized_keys | Re-deploy public key to remote server |
| Host key verification failed | Strict host key checking | Disable temporarily or add host key |

## Common Issues and Solutions

### Issue: "Could not load private key"

**Symptoms:**
- Service fails to start
- Test connection shows "invalid private key"

**Causes:**
1. Service account doesn't have read access to the private key file
2. Private key file path is incorrect
3. Private key file is corrupted or wrong format

**Solutions:**
```powershell
# 1. Check file exists
Test-Path "C:\ProgramData\ZLFileRelay\ssh\zlrelay_key"

# 2. Grant service account access
icacls "C:\ProgramData\ZLFileRelay\ssh\zlrelay_key" /grant "DOMAIN\svc_filetransfer:R"

# 3. Verify it's the private key (not .pub)
Get-ChildItem "C:\ProgramData\ZLFileRelay\ssh\"
```

### Issue: "Selected .pub file in Browse dialog"

**Symptoms:**
- Warning message: "You selected a public key (.pub) file"

**Solution:**
- In the Browse dialog, select the file **WITHOUT** `.pub` extension
- The public key is automatically found by appending `.pub` to the private key path

### Issue: "Service account has no profile"

**Symptoms:**
- SSH keys generate but service can't use them
- Access denied errors

**Solution:**
```powershell
# Create profile by logging in as service account
runas /user:DOMAIN\svc_filetransfer cmd

# Or manually create SSH directory
New-Item -ItemType Directory -Force -Path "C:\Users\svc_filetransfer\.ssh"
```

### Issue: "Public key won't copy to clipboard"

**Symptoms:**
- "Copy to Clipboard" doesn't work
- Empty clipboard

**Solution:**
1. Click **"View Public Key"** first to load it
2. Then click **"Copy to Clipboard"**
3. Or manually copy from: `C:\ProgramData\ZLFileRelay\ssh\zlrelay_key.pub`

## Security Best Practices

### Private Key Security
- âœ… Store private keys in `C:\ProgramData\ZLFileRelay\ssh\` (restricted access)
- âœ… Grant read access **only** to the service account
- âœ… Use NTFS permissions to restrict access
- âŒ Never store private keys in user profile directories
- âŒ Never email or share private keys
- âŒ Never commit private keys to source control

### Public Key Deployment
- âœ… Verify public key before deploying to production
- âœ… Use different keys for different environments (dev/test/prod)
- âœ… Document which public keys are deployed where
- âœ… Set correct permissions on `authorized_keys` (600 on Linux)

### Key Rotation
- ðŸ”„ Rotate SSH keys annually or when:
  - Service account changes
  - Security incident occurs
  - Employee with key access leaves
  - Moving to new environment

### Audit Trail
- ðŸ“ Enable SSH logging on remote servers
- ðŸ“ Monitor failed authentication attempts
- ðŸ“ Review ZL File Relay audit logs regularly
- ðŸ“ Track which keys are deployed to which servers

## File Locations Reference

### Default Locations

| Item | Path | Notes |
|------|------|-------|
| Private Key | `C:\ProgramData\ZLFileRelay\ssh\zlrelay_key` | Or `.key`, `.pem` extension |
| Public Key | `C:\ProgramData\ZLFileRelay\ssh\zlrelay_key.pub` | Or `.pem` extension |
| Service Config | `C:\ProgramData\ZLFileRelay\appsettings.json` | Main configuration file |
| Service Account Profile | `C:\Users\svc_filetransfer\` | Created on first login |

### Remote Server Locations

| OS | authorized_keys Path |
|----|---------------------|
| Linux/Unix | `/home/username/.ssh/authorized_keys` |
| Windows (OpenSSH) | `C:\Users\username\.ssh\authorized_keys` |

## Advanced Configuration

### Using Existing Keys

If you have existing SSH keys from another system:

**Example 1: OpenSSH Keys (Linux/Unix style)**
```
Source keys:
- id_ed25519 (private)
- id_ed25519.pub (public)

Steps:
1. Copy both files to: C:\ProgramData\ZLFileRelay\ssh\
2. Grant service account read access to the private key
3. In Config Tool, browse to: C:\ProgramData\ZLFileRelay\ssh\id_ed25519
4. Test connection
```

**Example 2: Web Server Keys (.key/.pem style)**
```
Source keys:
- server.key (private, PEM format)
- server.pem (public/certificate)

Steps:
1. Copy both files to: C:\ProgramData\ZLFileRelay\ssh\
2. Grant service account read access to server.key
3. In Config Tool, browse to: C:\ProgramData\ZLFileRelay\ssh\server.key
4. Test connection
```

**Example 3: Generic PEM Keys**
```
Source keys:
- mykey.pem (private)
- mykey.pub (public)

Steps:
1. Copy both files to: C:\ProgramData\ZLFileRelay\ssh\
2. Grant service account read access to mykey.pem
3. In Config Tool, browse to: C:\ProgramData\ZLFileRelay\ssh\mykey.pem
4. Test connection
```

> **Important:** Always browse to the **private** key file. The public key is automatically found if it follows these conventions:
> - Same name with `.pub` extension (e.g., `server.key` â†’ `server.key.pub`)
> - Same base name with `.pub` (e.g., `server.key` â†’ `server.pub`)
> - Same base name with `.pem` (e.g., `server.key` â†’ `server.pem`)

### Multiple Environments

For different environments (DMZ, OT, etc.):

```plaintext
C:\ProgramData\ZLFileRelay\ssh\
â”œâ”€â”€ dmz_key          (DMZ environment private key)
â”œâ”€â”€ dmz_key.pub      (DMZ environment public key)
â”œâ”€â”€ ot_key           (OT environment private key)
â””â”€â”€ ot_key.pub       (OT environment public key)
```

Configure each deployment to use the appropriate key file.

### Key Passphrase Protection

For additional security, you can protect private keys with a passphrase:

**Note:** Current version doesn't support passphrase-protected keys in the service. This is planned for a future release.

Workaround: Use Windows DPAPI or Azure Key Vault for key management.

## Troubleshooting Checklist

When SSH connection fails, check this list:

- [ ] Service account has logged in at least once (profile exists)
- [ ] Private key file exists at specified path
- [ ] Service account has **read** access to private key file
- [ ] Public key is deployed to remote server's `authorized_keys`
- [ ] Remote server's `authorized_keys` has correct permissions (600)
- [ ] Remote server's `.ssh` directory has correct permissions (700)
- [ ] SSH username matches the user whose `authorized_keys` was modified
- [ ] Remote server's SSH service is running
- [ ] Firewall allows SSH traffic (port 22 or custom)
- [ ] Network connectivity between servers exists
- [ ] Remote server type (Windows/Linux) is correctly set

## Additional Resources

- [OpenSSH Key Management](https://www.openssh.com/manual.html)
- [ED25519 vs RSA Keys](https://security.stackexchange.com/questions/90077/ssh-key-ed25519-vs-rsa)
- [Windows OpenSSH Setup](https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse)
- [SSH.NET Documentation](https://github.com/sshnet/SSH.NET)

## Support

For additional help:
- Check the Config Tool's built-in SSH setup guide (expandable section)
- Review service logs: `C:\FileRelay\logs\`
- Enable verbose logging in `appsettings.json`
- Contact your system administrator

---

**Last Updated:** January 2025  
**Version:** ZL File Relay 1.0

